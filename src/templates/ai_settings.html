{% extends "base.html" %}

{% block title %}AI Settings - Velo Vision{% endblock %}

{% block extra_style %}
.toast {
position: fixed;
bottom: 2rem;
right: 2rem;
padding: 1rem 1.5rem;
border-radius: 1rem;
background: #dfffad;
color: #1a1a1a;
font-weight: bold;
transform: translateY(100px);
transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
z-index: 1000;
}
.toast.show { transform: translateY(0); }
{% endblock %}

{% block content %}
<div class="p-8">
    <header class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-3xl font-semibold">AI Configuration</h2>
            <p class="text-gray-400 text-sm mt-1">Provider authentication and model management</p>
        </div>
        <button id="saveBtn" onclick="saveSettings()"
            class="bg-[#dfffad] text-[#1a1a1a] px-6 py-2 rounded-full text-sm font-bold hover:brightness-90 transition-all shadow-lg shadow-[#dfffad]/20">
            Save Configuration
        </button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-8">
            <section class="card rounded-3xl p-8">
                <h3 class="text-xl font-medium mb-6 flex items-center gap-3"><i
                        class="fa-solid fa-microchip text-[#dfffad]"></i> Service Provider</h3>
                <div class="space-y-6">
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">Provider</label>
                        <select id="provider"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-sm text-white focus:border-[#dfffad] focus:outline-none">
                            <option value="gemini">Google Gemini AI</option>
                            <option value="openai" disabled>OpenAI (Soon)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">API
                            Key</label>
                        <div class="relative">
                            <input type="password" id="apiKey" placeholder="sk-..."
                                class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-sm text-white focus:border-[#dfffad] focus:outline-none font-mono pr-12">
                            <button onclick="toggleKey()"
                                class="absolute right-4 top-3 text-gray-500 hover:text-white transition-colors"><i
                                    class="fa-solid fa-eye"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">Model
                            ID</label>
                        <div class="flex gap-3">
                            <select id="modelName"
                                class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-sm text-white focus:border-[#dfffad] focus:outline-none font-mono">
                                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            </select>
                            <button onclick="fetchModels()" id="fetchBtn"
                                class="bg-[#333] hover:bg-[#444] px-5 py-3 rounded-xl text-xs font-bold transition-all flex items-center gap-2">
                                <i class="fa-solid fa-arrows-rotate"></i> Sync
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card rounded-3xl p-8">
                <h3 class="text-xl font-medium mb-6 flex items-center gap-3"><i
                        class="fa-solid fa-sliders text-blue-400"></i> Engine Parameters</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">Max
                            Tokens</label>
                        <input type="number" id="maxTokens" value="512"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-sm text-white focus:border-[#dfffad] focus:outline-none">
                    </div>
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">Temperature</label>
                        <input type="number" step="0.1" id="temperature" value="0.7"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-sm text-white focus:border-[#dfffad] focus:outline-none">
                    </div>
                </div>
            </section>
        </div>

        <div class="lg:col-span-1 space-y-8">
            <div class="card rounded-3xl p-8 border-l-4 border-l-[#dfffad]">
                <h3 class="text-lg font-bold mb-6 flex items-center gap-2"><i
                        class="fa-solid fa-chart-line text-purple-400"></i> Usage Metrics</h3>
                <div class="space-y-8">
                    <div class="text-center py-6 border-b border-gray-800">
                        <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-widest mb-1">Today's
                            Inferences</span>
                        <span class="block text-5xl font-black text-white">0</span>
                        <span class="text-xs text-gray-600 mt-2 block">AI Analysis Calls</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast">Configuration Saved</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function toggleKey() {
        const input = document.getElementById('apiKey');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function fetchModels() {
        const btn = document.getElementById('fetchBtn');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i>';
        btn.disabled = true;
        try {
            const res = await fetch('/api/ai/models');
            const data = await res.json();
            const select = document.getElementById('modelName');
            const currentVal = select.value;
            if (data.models && data.models.length > 0) {
                select.innerHTML = '';
                data.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.innerText = m;
                    select.appendChild(opt);
                });
                if (data.models.includes(currentVal)) select.value = currentVal;
                showToast("Models synced");
            }
        } catch (err) { showToast("Sync failed"); }
        finally { btn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> Sync'; btn.disabled = false; }
    }

    async function loadSettings() {
        try {
            const res = await fetch('/api/settings');
            const config = await res.json();
            if (config.ai) {
                document.getElementById('apiKey').value = config.ai.api_key || '';
                document.getElementById('maxTokens').value = config.ai.max_tokens || 512;
                document.getElementById('temperature').value = config.ai.temperature || 0.7;
            }
        } catch (e) { }
    }

    async function saveSettings() {
        const btn = document.getElementById('saveBtn');
        btn.innerText = 'Syncing...';
        btn.disabled = true;
        const settings = {
            ai: {
                provider: 'gemini',
                api_key: document.getElementById('apiKey').value,
                model: document.getElementById('modelName').value,
                max_tokens: parseInt(document.getElementById('maxTokens').value),
                temperature: parseFloat(document.getElementById('temperature').value)
            }
        };
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            if (res.ok) showToast('Synchronized!');
        } catch (err) { showToast('Save Failed'); }
        finally { btn.innerText = 'Save Configuration'; btn.disabled = false; }
    }
    loadSettings();
</script>
{% endblock %}