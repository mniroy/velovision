{% extends "base.html" %}

{% block title %}Person - Velo Vision{% endblock %}

{% block content %}
<div class="p-8">
    <header class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-h1 font-black tracking-tight">Person Recognition</h2>
            <p class="text-gray-400 text-body mt-1">Manage known individuals</p>
        </div>
        <button onclick="document.getElementById('addFaceModal').classList.remove('hidden')"
            class="bg-[#dfffad] text-[#1a1a1a] px-5 py-2 rounded-full text-body font-black hover:brightness-90 transition-all flex items-center gap-2 shadow-lg shadow-[#dfffad]/20 uppercase tracking-widest">
            <i class="fa-solid fa-plus text-xs"></i> Add New Person
        </button>
    </header>

    <!-- UNLABELED PEOPLE (AI Discoveries) -->
    <section id="unlabeled-section" class="mb-12 hidden">
        <h3 class="text-caption font-black uppercase tracking-widest text-[#dfffad] mb-6 flex items-center gap-2">
            <i class="fa-solid fa-wand-magic-sparkles"></i> AI Discoveries: People to Identify
        </h3>
        <div id="unlabeled-grid" class="flex gap-6 overflow-x-auto pb-6 custom-scrollbar">
            <!-- Populated by JS -->
        </div>
    </section>

    <!-- Category Filter Pills -->
    <div class="flex flex-wrap gap-2 mb-8">
        <button onclick="filterByCategory('all')" data-cat="all"
            class="cat-pill active px-4 py-1.5 rounded-full text-caption font-black uppercase tracking-widest transition-all">All</button>
    </div>

    <div id="faces-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        <div class="col-span-full text-center py-12 text-gray-500">
            <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading faces...</p>
        </div>
    </div>
</div>

<!-- Add Face Modal -->
<div id="addFaceModal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#2d2d2d] border border-gray-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-h2 font-black tracking-tight">Add New Person</h3>
            <button onclick="document.getElementById('addFaceModal').classList.add('hidden')"
                class="text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <form id="addFaceForm" class="p-6 space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" name="name" required placeholder="e.g. Royyan"
                    class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-[#dfffad] focus:outline-none">
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Category</label>
                <select name="category" id="addFaceCategory"
                    class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-[#dfffad] focus:outline-none">
                    <option value="Uncategorized">Uncategorized</option>
                    <option value="Family">Family</option>
                    <option value="Friend">Friend</option>
                    <option value="Courier">Courier</option>
                    <option value="Neighbor">Neighbor</option>
                    <option value="Staff">Staff</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Photo (Face visible)</label>
                <input type="file" name="file" accept="image/*" required
                    class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#333] file:text-white hover:file:bg-[#444]">
            </div>
            <div class="pt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('addFaceModal').classList.add('hidden')"
                    class="px-5 py-2 rounded-xl text-gray-400 hover:text-white font-medium">Cancel</button>
                <button type="submit" id="submitBtn"
                    class="bg-[#dfffad] text-[#1a1a1a] px-6 py-2 rounded-xl font-bold hover:brightness-90 transition-all">Upload
                    & Train</button>
            </div>
        </form>
    </div>
</div>

<!-- Identity Modal (Label Discoveries) -->
<div id="labelModal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#2d2d2d] border border-gray-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-[#dfffad]/10">
            <h3 class="text-h2 font-black tracking-tight">Identify Person</h3>
            <button onclick="document.getElementById('labelModal').classList.add('hidden')"
                class="text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div class="p-6 flex flex-col items-center">
            <img id="labelImg" src=""
                class="w-32 h-32 rounded-full object-cover border-4 border-[#dfffad] shadow-xl mb-6">
            <form id="labelForm" class="w-full space-y-4">
                <input type="hidden" name="id" id="labelId">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Who is this?</label>
                    <input type="text" name="name" id="labelName" required placeholder="Full Name" list="knownNames"
                        class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-[#dfffad] focus:outline-none">
                    <datalist id="knownNames"></datalist>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Category</label>
                    <select name="category" required
                        class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-[#dfffad] focus:outline-none">
                        <option value="Family">Family</option>
                        <option value="Friend">Friend</option>
                        <option value="Neighbor">Neighbor</option>
                        <option value="Staff">Staff</option>
                        <option value="Courier">Courier</option>
                        <option value="Uncategorized" selected>Uncategorized</option>
                    </select>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="deleteDiscovery()"
                        class="px-5 py-3 rounded-xl text-red-400 hover:bg-red-400/10 font-medium transition-all text-body">Dismiss</button>
                    <button type="submit" id="labelBtn"
                        class="flex-1 bg-[#dfffad] text-[#1a1a1a] px-6 py-3 rounded-xl font-bold hover:brightness-90 transition-all text-body">Save
                        Identity</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sightings Modal -->
<div id="sightingsModal"
    class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
    <div
        class="bg-[#1a1a1a] border border-gray-800 w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-6 border-b border-gray-800 flex justify-between items-center">
            <div>
                <h2 id="sightingsTitle" class="text-h2 font-bold text-white">Associated Pictures</h2>
                <p id="sightingsSubtitle" class="text-caption text-gray-500 uppercase tracking-widest mt-1">Sightings
                    detected by AI</p>
            </div>
            <button onclick="document.getElementById('sightingsModal').classList.add('hidden')"
                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:text-white transition-all">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        <div id="sightingsGrid"
            class="p-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar">
            <!-- Populated by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const categoryColors = {
        'Family': { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/30' },
        'Friend': { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/30' },
        'Courier': { bg: 'bg-amber-500/20', text: 'text-amber-400', border: 'border-amber-500/30' },
        'Neighbor': { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30' },
        'Staff': { bg: 'bg-cyan-500/20', text: 'text-cyan-400', border: 'border-cyan-500/30' },
        'Uncategorized': { bg: 'bg-gray-500/20', text: 'text-gray-400', border: 'border-gray-500/30' },
    };

    let allFaces = [];
    let allCategories = [];
    let activeFilter = 'all';

    function getCatStyle(cat) {
        return categoryColors[cat] || categoryColors['Uncategorized'];
    }

    function filterByCategory(cat) {
        activeFilter = cat;
        document.querySelectorAll('.cat-pill').forEach(b => {
            b.classList.toggle('active', b.dataset.cat === cat);
        });
        renderFaces();
    }

    async function loadUnlabeled() {
        try {
            const res = await fetch('/api/faces/unlabeled');
            const data = await res.json();
            const section = document.getElementById('unlabeled-section');
            const grid = document.getElementById('unlabeled-grid');

            if (data && data.length > 0) {
                section.classList.remove('hidden');
                grid.innerHTML = data.map(p => `
                    <div class="shrink-0 w-48 group cursor-pointer" onclick="openLabelModal(${p.id})">
                        <div class="aspect-square rounded-2xl overflow-hidden border-2 border-transparent group-hover:border-[#dfffad] transition-all relative">
                            <img src="/api/faces/unlabeled/${p.id}/image" class="w-full h-full object-cover">
                            <div class="absolute inset-x-0 bottom-0 bg-black/60 backdrop-blur-sm p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                <p class="text-caption font-bold text-center text-[#dfffad] uppercase tracking-widest">Identify</p>
                            </div>
                        </div>
                        <p class="mt-2 text-caption text-gray-500 font-mono text-center uppercase tracking-tighter">${new Date(p.timestamp).toLocaleString()}</p>
                    </div>
                `).join('');
            } else {
                section.classList.add('hidden');
            }
        } catch (e) { console.error('Load unlabeled error:', e); }
    }

    function openLabelModal(id) {
        document.getElementById('labelId').value = id;
        document.getElementById('labelImg').src = `/api/faces/unlabeled/${id}/image`;
        document.getElementById('labelModal').classList.remove('hidden');
    }

    async function deleteDiscovery() {
        const id = document.getElementById('labelId').value;
        if (confirm('Dismiss this discovery?')) {
            await fetch(`/api/faces/unlabeled/${id}`, { method: 'DELETE' });
            document.getElementById('labelModal').classList.add('hidden');
            loadUnlabeled();
        }
    }

    document.getElementById('labelForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('labelId').value;
        const btn = document.getElementById('labelBtn');
        btn.innerText = 'Saving...'; btn.disabled = true;
        const formData = new FormData(e.target);
        // Remove the hidden 'id' field from body â€” it's already in the URL path
        formData.delete('id');
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 30000);
            const res = await fetch(`/api/faces/unlabeled/${id}/label`, {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });
            clearTimeout(timeout);
            if (res.ok) {
                document.getElementById('labelModal').classList.add('hidden');
                loadUnlabeled();
                loadFaces();
            } else {
                let msg = 'Failed to save';
                try { const err = await res.json(); msg = err.detail || msg; } catch (_) { }
                alert(msg);
            }
        } catch (err) {
            console.error('Label save error:', err);
            if (err.name === 'AbortError') {
                alert('Request timed out. The server may be busy processing. Please try again.');
            } else {
                alert('Network error: ' + err.message);
            }
        } finally { btn.innerText = 'Save Identity'; btn.disabled = false; }
    };

    function renderFaces() {
        const grid = document.getElementById('faces-grid');
        const filtered = activeFilter === 'all' ? allFaces : allFaces.filter(f => f.category === activeFilter);

        if (filtered.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500 text-body">${activeFilter === 'all' ? 'No known faces yet.' : `No faces in "${activeFilter}" category.`}</div>`;
            return;
        }

        grid.innerHTML = '';
        filtered.forEach(face => {
            const style = getCatStyle(face.category);
            const card = document.createElement('div');
            card.className = 'card rounded-3xl p-6 flex flex-col items-center relative group border border-gray-800 hover:border-gray-600 transition-all bg-[#1a1a1a]';
            card.innerHTML = `
                <div class="cursor-pointer mb-4" onclick="viewSightings('${face.name}')">
                    <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-gray-600 p-0.5 bg-[#262626] group-hover:border-[#dfffad] group-hover:scale-105 transition-all shadow-xl">
                        <img src="/api/faces/${encodeURIComponent(face.name)}/image" class="w-full h-full object-cover rounded-full" 
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="hidden w-full h-full bg-gray-800 items-center justify-center text-h3 font-bold text-gray-500 rounded-full">${face.name[0].toUpperCase()}</div>
                    </div>
                </div>
                <h3 class="font-bold text-h3 text-white mb-1 text-center">${face.name}</h3>
                <p class="text-caption text-gray-500 uppercase tracking-widest mb-5 font-bold">${face.sighting_count || 0} Discovery Captures</p>
                
                <select onchange="updateCategory('${face.name}', this.value)" class="w-full bg-[#262626] border ${style.border} rounded-xl px-4 py-2.5 text-caption ${style.text} font-black text-center focus:outline-none focus:border-[#dfffad] cursor-pointer mb-4 transition-all uppercase tracking-wider">
                    ${allCategories.map(c => `<option value="${c}" ${c === face.category ? 'selected' : ''} class="text-white bg-[#1a1a1a]">${c}</option>`).join('')}
                </select>
                
                <div class="flex gap-2 w-full mt-auto">
                    <button onclick="viewSightings('${face.name}')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 text-caption font-black py-2.5 rounded-xl transition-all uppercase tracking-widest">
                        <i class="fa-solid fa-images mr-1 opacity-60"></i> Captures
                    </button>
                    <button onclick="deleteFace('${face.name}')" class="px-4 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-caption font-bold py-2.5 rounded-xl transition-all">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`;
            grid.appendChild(card);
        });
    }

    async function viewSightings(name) {
        document.getElementById('sightingsTitle').innerText = `${name}'s Captures`;
        const grid = document.getElementById('sightingsGrid');
        grid.innerHTML = '<p class="col-span-full text-center py-12 text-gray-500 text-body"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Scanning gallery...</p>';
        document.getElementById('sightingsModal').classList.remove('hidden');

        try {
            const res = await fetch(`/api/faces/${encodeURIComponent(name)}/sightings`);
            const data = await res.json();

            if (data.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-12 text-gray-500 text-body">No event captures found for this person.</p>';
                return;
            }

            grid.innerHTML = data.map(s => `
                <div class="group relative aspect-square rounded-2xl overflow-hidden border border-gray-800 bg-[#262626]">
                    <img src="${s.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                    <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4 opacity-0 group-hover:opacity-100 transition-opacity">
                        <p class="text-caption font-bold text-[#dfffad] mb-0.5 uppercase tracking-widest">${s.camera_id}</p>
                        <p class="text-caption text-gray-400 font-mono">${new Date(s.timestamp).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            grid.innerHTML = '<p class="text-red-500 col-span-full text-center text-body">Failed to load captures.</p>';
        }
    }

    async function loadFaces() {
        const grid = document.getElementById('faces-grid');
        try {
            const [facesRes, catRes] = await Promise.all([
                fetch('/api/faces'),
                fetch('/api/faces/categories')
            ]);
            const facesData = await facesRes.json();
            const catData = await catRes.json();

            allFaces = facesData.faces || [];
            allCategories = catData.categories || ['Uncategorized'];

            // Build category pills
            const pillContainer = document.querySelector('.flex.flex-wrap.gap-2.mb-8');
            pillContainer.innerHTML = '<button onclick="filterByCategory(\'all\')" data-cat="all" class="cat-pill active px-4 py-1.5 rounded-full text-xs font-bold tracking-wide transition-all">All</button>';
            allCategories.forEach(c => {
                const style = getCatStyle(c);
                const count = allFaces.filter(f => f.category === c).length;
                if (count > 0 || ['Family', 'Friend', 'Courier', 'Neighbor', 'Staff'].includes(c)) {
                    pillContainer.innerHTML += `<button onclick="filterByCategory('${c}')" data-cat="${c}" class="cat-pill px-4 py-1.5 rounded-full text-xs font-bold tracking-wide transition-all">${c} <span class="ml-1 opacity-60">${count}</span></button>`;
                }
            });

            // Update active filter
            document.querySelectorAll('.cat-pill').forEach(b => {
                b.classList.toggle('active', b.dataset.cat === activeFilter);
            });

            // Update datalist for name labeling
            const datalist = document.getElementById('knownNames');
            if (datalist) {
                datalist.innerHTML = allFaces.map(f => `<option value="${f.name}">`).join('');
            }

            renderFaces();
        } catch (err) { grid.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to load faces.</p>'; }
    }

    async function updateCategory(name, category) {
        try {
            const res = await fetch(`/api/faces/${encodeURIComponent(name)}/category`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category })
            });
            if (res.ok) loadFaces();
        } catch (e) { console.error('Update category error:', e); }
    }

    async function deleteFace(name) {
        if (confirm(`Delete ${name}?`)) {
            await fetch(`/api/faces/${name}`, { method: 'DELETE' });
            loadFaces();
        }
    }

    document.getElementById('addFaceForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = 'Uploading...'; btn.disabled = true;
        const formData = new FormData(e.target);
        const name = formData.get('name');
        const category = formData.get('category');
        formData.delete('category');
        try {
            const res = await fetch(`/api/faces?name=${encodeURIComponent(name)}&category=${encodeURIComponent(category)}`, { method: 'POST', body: formData });
            if (res.ok) { document.getElementById('addFaceModal').classList.add('hidden'); e.target.reset(); loadFaces(); }
        } finally { btn.innerText = 'Upload & Train'; btn.disabled = false; }
    };
    loadFaces();
    loadUnlabeled();
</script>
{% endblock %}