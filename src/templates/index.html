{% extends "base.html" %}

{% block title %}Dashboard - Velo Vision{% endblock %}

{% block content %}
<div class="p-8">
    <header class="flex justify-between items-center mb-10">
        <div class="relative w-full max-w-md">
            <i
                class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
            <input type="text" placeholder="Search events..."
                class="w-full bg-[#262626] rounded-full py-3 pl-12 pr-4 text-body focus:outline-none focus:ring-1 focus:ring-gray-600">
        </div>
        <div class="flex items-center gap-6 ml-4">
            <div class="text-right hidden sm:block">
                <p id="clock" class="text-h3 font-black text-white leading-none"></p>
                <p id="date" class="text-caption text-gray-500 uppercase tracking-widest mt-1 font-bold"></p>
            </div>
            <button onclick="toggleNotifications()"
                class="relative w-10 h-10 rounded-full bg-[#262626] flex items-center justify-center hover:bg-[#333] transition-colors">
                <i class="fa-regular fa-bell text-gray-400"></i>
                <span id="notif-dot" class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
        </div>
    </header>

    <div class="grid grid-cols-12 gap-8">
        <!-- Camera Grid -->
        <section class="col-span-12">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-h2 font-black mb-1">Live Feeds</h2>
                    <span id="camera-count"
                        class="text-gray-400 text-caption uppercase tracking-wider">Syncing...</span>
                </div>
            </div>
            <div id="cameras-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="aspect-video bg-[#262626] rounded-3xl animate-pulse"></div>
            </div>
        </section>

        <!-- Activity Log -->
        <div class="col-span-12 lg:col-span-8 card rounded-3xl p-6 flex flex-col h-full">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-h2 font-bold tracking-tight">Activity Log</h3>
                    <p id="activity-subtitle" class="text-gray-500 text-body mt-1">Detections this week</p>
                </div>
                <div class="text-right">
                    <span id="total-events-count" class="text-h1 font-black text-white leading-none">0</span>
                    <p class="text-caption text-gray-500 uppercase font-black tracking-widest mt-1">Total Events</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 mb-5">
                <div id="period-pills" class="flex bg-[#262626] rounded-full p-1 gap-1">
                    <button onclick="setPeriod('week')" data-period="week"
                        class="period-pill active px-4 py-1.5 rounded-full text-caption font-black uppercase tracking-widest transition-all">Week</button>
                    <button onclick="setPeriod('month')" data-period="month"
                        class="period-pill px-4 py-1.5 rounded-full text-caption font-black uppercase tracking-widest transition-all">Month</button>
                    <button onclick="setPeriod('ytd')" data-period="ytd"
                        class="period-pill px-4 py-1.5 rounded-full text-caption font-black uppercase tracking-widest transition-all">YTD</button>
                    <button onclick="setPeriod('all')" data-period="all"
                        class="period-pill px-4 py-1.5 rounded-full text-caption font-black uppercase tracking-widest transition-all">All</button>
                </div>
                <select id="category-filter" onchange="loadActivity()"
                    class="bg-[#262626] border border-gray-700 rounded-full px-4 py-1.5 text-caption font-black uppercase tracking-widest text-gray-300 focus:outline-none focus:border-[#dfffad] cursor-pointer appearance-none pr-8"
                    style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239ca3af%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center;">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <div id="activity-bars" class="flex justify-between items-end flex-1 w-full gap-3 min-h-[160px]">
                <!-- Dynamic Bars -->
            </div>
        </div>

        <div class="col-span-12 lg:col-span-4 h-full">
            <div id="latest-event-card"
                class="card rounded-3xl p-6 flex flex-col h-full relative overflow-hidden group">
                <h3 class="text-h2 font-bold mb-4">Recent Detections</h3>
                <div id="latest-content" class="flex-1 flex flex-col gap-4 mt-2">
                    <i class="fa-solid fa-video-slash text-gray-600 text-3xl"></i>
                </div>
                <div class="mt-4">
                    <a href="/timeline"
                        class="block bg-white/10 text-center py-3 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-white/20 transition-colors">View
                        History</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Panel -->
<div id="notifPanel" class="notification-panel">
    <div class="flex justify-between items-center mb-8">
        <h3 class="text-xl font-bold text-white">Recent Alerts</h3>
        <button onclick="toggleNotifications()" class="text-gray-500 hover:text-white transition-colors">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
    </div>
    <div id="notif-list" class="space-y-4">
        <div class="text-center py-10 text-gray-600 italic">No recent alerts</div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentPeriod = 'week';
    const periodLabels = { week: 'Detections this week', month: 'Detections this month', ytd: 'Year to date', all: 'All time activity' };

    function setPeriod(p) {
        currentPeriod = p;
        document.querySelectorAll('.period-pill').forEach(b => {
            b.classList.toggle('active', b.dataset.period === p);
        });
        document.getElementById('activity-subtitle').textContent = periodLabels[p] || '';
        loadActivity();
    }

    async function loadCategories() {
        try {
            const res = await fetch('/api/faces/categories');
            if (!res.ok) return;
            const data = await res.json();
            const sel = document.getElementById('category-filter');
            const current = sel.value;
            sel.innerHTML = '<option value="all">All Categories</option>';
            (data.categories || []).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                if (c === current) opt.selected = true;
                sel.appendChild(opt);
            });
        } catch (e) { console.error('Category load error:', e); }
    }

    async function loadActivity() {
        try {
            const cat = document.getElementById('category-filter').value;
            const res = await fetch(`/api/activity?period=${currentPeriod}&category=${encodeURIComponent(cat)}`);
            const activity = res.ok ? await res.json() : [];
            const barContainer = document.getElementById('activity-bars');
            if (barContainer && Array.isArray(activity)) {
                barContainer.innerHTML = '';
                const maxCount = Math.max(...activity.map(d => d.count || 0), 1);
                const totalInPeriod = activity.reduce((s, d) => s + (d.count || 0), 0);
                document.getElementById('total-events-count').innerText = totalInPeriod;
                activity.forEach(d => {
                    const height = (d.count / maxCount) * 100;
                    const barColor = d.is_today ? 'bg-[#dfffad]' : 'bg-[#333]';
                    const glow = d.is_today ? 'shadow-[0_0_15px_rgba(223,255,173,0.3)]' : '';
                    const div = document.createElement('div');
                    div.className = "flex flex-col items-center justify-end gap-2 flex-1 h-full group cursor-pointer";
                    div.innerHTML = `
                        <div class="relative w-full ${barColor} ${glow} rounded-t-lg transition-all" style="height: ${Math.max(height, 5)}%">
                             <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black/80 text-caption px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">${d.count || 0}</div>
                        </div>
                        <span class="text-caption ${d.is_today ? 'text-white font-bold' : 'text-gray-500'} whitespace-nowrap">${d.label}</span>
                    `;
                    barContainer.appendChild(div);
                });
            }
        } catch (e) { console.error('Activity load error:', e); }
    }

    async function loadDashboard() {
        try {
            const [sRes, cRes, eRes, aRes] = await Promise.all([
                fetch('/api/stats'),
                fetch('/api/settings'),
                fetch('/api/events?limit=5'),
                fetch('/api/action_logs?limit=5')
            ]);

            const stats = sRes.ok ? await sRes.json() : {};
            const config = cRes.ok ? await cRes.json() : {};
            let recentEvents = eRes.ok ? await eRes.json() : [];
            const actionLogs = aRes.ok ? await aRes.json() : [];

            // Merge and sort
            recentEvents = [...recentEvents, ...actionLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);

            if (stats.total_events !== undefined) {
                document.getElementById('camera-count').innerText = `${stats.active_cameras || 0} streams connected`;
            }

            // Update Notification List
            const notifList = document.getElementById('notif-list');
            if (notifList && Array.isArray(recentEvents) && recentEvents.length > 0) {
                notifList.innerHTML = '';
                recentEvents.forEach(ev => {
                    const isAction = ev.type !== undefined;
                    let title, detail, image;

                    if (isAction) {
                        title = ev.type === 'home_patrol' ? 'Home Patrol' : 'Person Finder';
                        detail = ev.summary;
                        image = ev.image_url;
                    } else {
                        title = ev.camera_id;
                        detail = ev.faces && ev.faces.length > 0 ? ev.faces.join(', ') : 'Motion Detected';
                        image = ev.image_url;
                    }

                    const item = document.createElement('div');
                    item.className = "flex gap-4 p-4 rounded-2xl bg-[#262626] border border-gray-800 hover:border-gray-700 transition-colors cursor-pointer group";
                    // Link to timeline if clicked?
                    item.onclick = () => window.location.href = '/timeline';

                    item.innerHTML = `
                        <img src="${image}" class="w-12 h-12 rounded-full object-cover border border-gray-700 group-hover:border-gray-500 transition-colors" onerror="handleImageError(this)">
                        <div>
                            <p class="text-caption font-bold text-white uppercase tracking-tighter">${title}</p>
                            <p class="text-caption text-gray-500">${new Date(ev.timestamp).toLocaleTimeString()}</p>
                            <p class="text-caption ${isAction ? 'text-blue-400' : 'text-[#dfffad]'} mt-1 line-clamp-1">${detail}</p>
                        </div>
                    `;
                    notifList.appendChild(item);
                });
                document.getElementById('notif-dot').classList.remove('hidden');
            }

            // Update Camera Grid
            const cameras = config.cameras || {};
            const grid = document.getElementById('cameras-grid');
            if (grid) {
                grid.innerHTML = '';
                Object.entries(cameras).forEach(([id, cam]) => {
                    if (cam.on_dashboard === false) return;
                    const div = document.createElement('div');
                    div.className = "relative bg-[#262626] rounded-3xl overflow-hidden aspect-video group border border-gray-800 hover:border-gray-600 transition-all cursor-pointer";
                    div.onclick = () => enlargeCamera(id, cam.name);
                    div.innerHTML = `
                        <img src="/api/snapshot?camera_id=${id}&t=${Date.now()}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" onerror="handleImageError(this)">
                        <div class="absolute top-4 left-4 bg-black/40 backdrop-blur-md px-3 py-1 rounded-full text-caption font-black tracking-widest text-white border border-white/10 uppercase">${cam.name}</div>
                        <div class="absolute top-4 right-4 flex items-center gap-1.5 bg-black/40 backdrop-blur-md px-2 py-1 rounded-full border border-white/10">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full shadow-[0_0_5px_rgba(34,197,94,0.5)]"></span>
                            <span class="text-[8px] font-black text-white tracking-widest uppercase">Live View</span>
                        </div>
                        <div class="absolute bottom-4 right-4 bg-white/10 backdrop-blur-md w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/20 transition-colors">
                            <i class="fa-solid fa-expand text-[10px]"></i>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }

            // Update Recent Detections Card
            const latestContent = document.getElementById('latest-content');
            if (latestContent && Array.isArray(recentEvents) && recentEvents.length > 0) {
                latestContent.innerHTML = '';
                // Show top 4 recent events
                recentEvents.slice(0, 4).forEach((ev, idx) => {
                    const isAction = ev.type !== undefined;
                    const title = isAction ? (ev.type === 'home_patrol' ? 'Home Patrol' : 'Person Finder') : (ev.camera_id || 'Camera');
                    const faceLabel = isAction ? (ev.type === 'home_patrol' ? 'System patrol' : 'Searching...') : (ev.faces && ev.faces.length > 0 ? ev.faces.join(', ') : 'Motion Detected');
                    const description = ev.analysis_text || ev.summary || '';
                    const image = ev.image_url;

                    if (idx === 0) {
                        // Featured Latest
                        latestContent.innerHTML += `
                            <div class="w-full space-y-3 pb-4 mb-2 border-b border-white/5">
                                <div class="relative w-full aspect-video rounded-2xl overflow-hidden border border-white/5 cursor-pointer group" onclick="enlargeImage('${image}', '${title}')">
                                    <img src="${image}" class="w-full h-full object-cover transition-transform group-hover:scale-105" onerror="handleImageError(this)">
                                    <div class="absolute inset-0 bg-white/0 group-hover:bg-white/10 flex items-center justify-center transition-all">
                                        <i class="fa-solid fa-expand text-white text-xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                    </div>
                                    <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded-full text-[10px] font-black tracking-widest text-white border border-white/10 uppercase">${title}</div>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <p class="text-body font-bold text-white capitalize">${faceLabel}</p>
                                        <p class="text-caption text-gray-500 italic">${new Date(ev.timestamp).toLocaleTimeString()}</p>
                                    </div>
                                    <p class="text-body text-gray-400 leading-relaxed line-clamp-2">${description}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Smaller entries
                        latestContent.innerHTML += `
                            <div class="flex gap-4 items-center group/item cursor-pointer hover:bg-white/5 p-2 rounded-xl transition-colors" onclick="enlargeImage('${image}', '${title}')">
                                <div class="relative w-16 h-12 flex-shrink-0">
                                    <img src="${image}" class="w-full h-full rounded-lg object-cover border border-gray-800" onerror="handleImageError(this)">
                                    ${isAction ? '<div class="absolute inset-0 bg-blue-500/10 rounded-lg"></div>' : ''}
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover/item:opacity-100 flex items-center justify-center transition-opacity rounded-lg">
                                        <i class="fa-solid fa-expand text-white text-[10px]"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2">
                                        <p class="text-caption font-bold text-white uppercase tracking-tight truncate">${title}: ${faceLabel}</p>
                                        <p class="text-[10px] text-gray-600 whitespace-nowrap">${new Date(ev.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                    <p class="text-caption text-gray-500 line-clamp-1">${description}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            } else if (latestContent) {
                latestContent.innerHTML = '<div class="flex-1 flex flex-col items-center justify-center text-gray-600 italic">No recent activity</div>';
            }
        } catch (e) { console.error("Dashboard Load Error:", e); }
    }
    function updateClock() {
        const now = new Date();
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };

        const clockEl = document.getElementById('clock');
        const dateEl = document.getElementById('date');

        if (clockEl) clockEl.innerText = now.toLocaleTimeString(undefined, timeOptions);
        if (dateEl) dateEl.innerText = now.toLocaleDateString(undefined, dateOptions);
    }

    setInterval(updateClock, 1000);
    updateClock();

    loadCategories();
    loadActivity();
    loadDashboard();
    setInterval(() => { loadDashboard(); loadActivity(); }, 15000);
</script>
{% endblock %}