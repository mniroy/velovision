{% extends "base.html" %}

{% block title %}AI Patrol - Velo Vision{% endblock %}

{% block extra_style %}
.card { background-color: #262626; border: 1px solid #333; }
.btn-primary { background-color: #dfffad; color: #1a1a1a; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
.pulse-glow { animation: pulse-glow 2s infinite; }
@keyframes pulse-glow {
0% { box-shadow: 0 0 0 0 rgba(223, 255, 173, 0.4); }
70% { box-shadow: 0 0 0 10px rgba(223, 255, 173, 0); }
100% { box-shadow: 0 0 0 0 rgba(223, 255, 173, 0); }
}
{% endblock %}

{% block content %}
<div class="p-8">
    <header class="mb-10 flex justify-between items-end">
        <div>
            <h2 class="text-3xl font-semibold">AI Patrol</h2>
            <p class="text-gray-400 text-sm mt-1">Central Intelligence & Multi-Camera Analysis</p>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Sidebar: Home Patrol Config -->
        <div class="space-y-6">
            <div class="card rounded-3xl p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-black uppercase tracking-widest text-gray-500">Home Patrol Config</h3>
                    <span id="active-cams-count"
                        class="text-[10px] font-bold bg-[#dfffad] text-[#1a1a1a] px-2 py-0.5 rounded-full">0
                        Cameras</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">Global
                            Context</label>
                        <textarea id="patrol-prompt" rows="3"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar"
                            placeholder="Instruction for holistic patrol..."></textarea>
                    </div>

                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">Message
                            Style</label>
                        <textarea id="patrol-msg" rows="2"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar"
                            placeholder="Delivery style for summary..."></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">WhatsApp
                            Trigger</label>
                        <input type="text" id="patrol-trigger"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none custom-scrollbar"
                            placeholder="e.g. how is home right now">
                    </div>


                    <div class="pt-4 border-t border-white/5 space-y-3">
                        <div class="flex items-center justify-between">
                            <label
                                class="text-[10px] text-gray-500 font-black uppercase tracking-widest leading-none">Recipients</label>
                            <button onclick="openPicker('patrol')"
                                class="text-[10px] font-bold text-[#dfffad] hover:underline">Select</button>
                        </div>
                        <div id="patrol-recipients-label"
                            class="p-3 bg-white/5 rounded-2xl border border-white/5 text-[10px] text-gray-400 min-h-[40px] flex items-center">
                            No recipients assigned
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/5 space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Periodic
                                Schedule</label>
                            <input type="checkbox" id="patrol-schedEnable"
                                class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="patrol-schedHrs" value="6"
                                class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2 text-xs text-white text-center focus:border-[#dfffad] focus:outline-none placeholder-gray-600 font-mono">
                            <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest">Hours</span>
                        </div>
                    </div>

                    <div class="pt-2 grid grid-cols-2 gap-3">
                        <button onclick="saveAllConfigs()"
                            class="bg-[#1a1a1a] border border-[#dfffad] text-[#dfffad] py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-[#dfffad] hover:text-[#1a1a1a] transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i> Save
                        </button>
                        <button onclick="runHomePatrol()"
                            class="pulse-glow bg-[#dfffad] text-[#1a1a1a] py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:brightness-90 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt"></i> Run
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main: Per-Camera Config -->
        <div class="xl:col-span-2 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-xl font-semibold">Camera Intelligence</h3>
            </div>

            <div id="camera-intelligence-list" class="space-y-6">
                <div class="text-center py-20 text-gray-600 italic">Scanning for cameras...</div>
            </div>
        </div>
    </div>
</div>

<!-- Recipients Picker Modal -->
<div id="pickerOverlay"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
    <div class="bg-[#262626] border border-gray-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden"
        onclick="event.stopPropagation()">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-[#1e1e1e]/50">
            <h3 class="text-xl font-semibold">Select Recipients</h3>
            <button onclick="closePicker()" class="text-gray-400 hover:text-white"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div id="picker-list" class="p-4 space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
            <!-- Items injected here -->
        </div>
        <div class="p-6 border-t border-gray-700 flex justify-end gap-3">
            <button onclick="closePicker()"
                class="bg-[#dfffad] text-[#1a1a1a] px-8 py-2 rounded-xl font-bold hover:brightness-90 transition-all">Done</button>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-8 right-8 bg-[#dfffad] text-black px-6 py-3 rounded-2xl font-bold shadow-2xl transform translate-y-28 opacity-0 transition-all duration-300 z-[300]">
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let allCameras = {};
    let allRecipients = [];
    let currentTargetCam = null;
    let patrolConfig = { prompt: '', recipients: [] };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('translate-y-28', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-28', 'opacity-0'), 3000);
    }

    function getRecipientNames(values) {
        if (!values || values.length === 0) return "No recipients assigned";
        return values.map(v => {
            const found = allRecipients.find(r => r.value === v);
            return found ? (found.label || found.name) : v;
        }).join(', ');
    }

    async function loadData() {
        try {
            const [cRes, sRes] = await Promise.all([fetch('/api/cameras'), fetch('/api/settings')]);
            const config = await sRes.json();
            allCameras = config.cameras || {};
            allRecipients = JSON.parse(config.whatsapp.recipients || "[]");
            patrolConfig = config.patrol || { prompt: '', recipients: [] };

            updatePatrolUI();
            renderIntelligenceList();
        } catch (e) { console.error(e); }
    }

    function updatePatrolUI() {
        const count = document.getElementById('active-cams-count');
        const activeCount = Object.values(allCameras).filter(c => c.enabled !== false).length;
        count.innerText = `${activeCount} Camera${activeCount !== 1 ? 's' : ''}`;

        document.getElementById('patrol-prompt').value = patrolConfig.prompt || '';
        document.getElementById('patrol-msg').value = patrolConfig.message_instruction || '';
        document.getElementById('patrol-trigger').value = patrolConfig.whatsapp_trigger_phrase || '';
        document.getElementById('patrol-schedEnable').checked = !!patrolConfig.schedule_enabled;
        document.getElementById('patrol-schedHrs').value = patrolConfig.schedule_interval_hrs || 6;

        const label = document.getElementById('patrol-recipients-label');
        label.innerText = getRecipientNames(patrolConfig.recipients);
    }

    function renderIntelligenceList() {
        const list = document.getElementById('camera-intelligence-list');
        list.innerHTML = '';

        Object.entries(allCameras).forEach(([id, cam]) => {
            const card = document.createElement('div');
            card.className = "card rounded-3xl overflow-hidden p-6 flex flex-col xl:flex-row gap-8 items-start";

            const camRecipients = cam.recipients || [];
            const recipientLabel = getRecipientNames(camRecipients);

            card.innerHTML = `
                <!-- Left Column: Media & Identity -->
                <div class="w-full xl:w-72 shrink-0 space-y-4">
                    <div class="aspect-video bg-black rounded-2xl overflow-hidden relative group border border-white/5 cursor-pointer" onclick="enlargeCamera('${id}', '${cam.name}')">
                        <img src="/api/snapshot?camera_id=${id}&t=${Date.now()}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 opacity-90 group-hover:opacity-100" onerror="handleImageError(this)">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all"></div>
                        <div class="absolute top-2 right-2 flex gap-1.5">
                            <div class="bg-black/60 px-2 py-1 rounded text-[8px] font-black uppercase tracking-widest text-[#dfffad] border border-[#dfffad]/20 backdrop-blur-md">
                                <i class="fa-solid fa-bolt mr-1"></i> Diagnostic
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 px-1">
                        <h4 class="font-bold text-white text-lg leading-tight truncate">${cam.name}</h4>
                        <p class="text-[9px] text-gray-500 font-mono tracking-widest uppercase">${id}</p>
                    </div>

                    <div class="pt-4 border-t border-white/5 px-1">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-[9px] text-gray-500 font-black uppercase tracking-widest">Alert Recipients</label>
                            <button onclick="openPicker('${id}')" class="text-[9px] font-bold text-[#dfffad] hover:underline">Edit</button>
                        </div>
                        <div class="bg-white/5 border border-white/5 rounded-xl p-3 text-[9px] text-gray-400 min-h-[36px] flex items-center">
                            <span id="label-${id}">${recipientLabel}</span>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Context & Automation -->
                <div class="flex-1 w-full space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest">AI Context</label>
                            <textarea id="prompt-${id}" rows="3" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar" placeholder="What should the AI look for?">${cam.analysis_prompt || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest">Notification Style</label>
                            <textarea id="msg-${id}" rows="3" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar" placeholder="How should the alert be phrased?">${cam.message_instruction || ''}</textarea>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-6 border-t border-white/5">
                        <!-- Triggers -->
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Webhook Trigger</label>
                                    <input type="checkbox" id="webEnable-${id}" ${cam.webhook_enabled ? 'checked' : ''} class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                                </div>
                                <div class="bg-[#1a1a1a] border border-gray-700 rounded-xl px-3 py-2 flex items-center">
                                    <input type="text" readonly value="/api/trigger/${id}" class="bg-transparent text-[9px] text-gray-500 w-full focus:outline-none font-mono">
                                    <i onclick="navigator.clipboard.writeText('/api/trigger/${id}'); showToast('Copied!')" class="fa-regular fa-copy text-gray-400 hover:text-white cursor-pointer ml-2"></i>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-[10px] text-gray-500 font-black uppercase tracking-widest">WhatsApp Trigger Phrase</label>
                                <input type="text" id="trigger-${id}" value="${cam.whatsapp_trigger_phrase || ''}" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2.5 text-xs text-white focus:border-[#dfffad] focus:outline-none" placeholder="e.g. status driveway">
                            </div>
                        </div>

                        <!-- Schedule & Actions -->
                        <div class="space-y-4 flex flex-col justify-between">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Periodic Auto-Check</label>
                                    <input type="checkbox" id="schedEnable-${id}" ${cam.schedule_enabled ? 'checked' : ''} class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="schedHrs-${id}" value="${cam.schedule_interval_hrs || 1}" class="w-20 bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2 text-xs text-white text-center focus:border-[#dfffad] focus:outline-none font-mono">
                                    <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest text-right">Hour Interval</span>
                                </div>
                            </div>

                            <div class="pt-4 flex gap-3">
                                <button onclick="triggerSingle('${id}')" class="flex-1 bg-white/5 border border-white/10 text-white py-2.5 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-white/10 transition-all">
                                    Test
                                </button>
                                <button onclick="saveAllConfigs()" class="flex-[2] bg-[#dfffad] text-[#1a1a1a] py-2.5 rounded-xl font-black uppercase text-[10px] tracking-widest hover:brightness-110 transition-all shadow-lg shadow-[#dfffad]/10">
                                    Save Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function openPicker(targetId) {
        currentTargetCam = targetId;
        const list = document.getElementById('picker-list');

        let selectedRecipients = [];
        if (targetId === 'patrol') {
            selectedRecipients = patrolConfig.recipients || [];
        } else {
            selectedRecipients = allCameras[targetId].recipients || [];
        }

        list.innerHTML = allRecipients.map(r => `
            <label class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/10 transition-all mb-2 last:mb-0">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-[#dfffad]/10 text-[#dfffad] flex items-center justify-center font-bold text-sm">
                        ${r.type === 'person' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-users"></i>'}
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white">${r.label || r.name}</p>
                        <p class="text-[10px] text-gray-500 font-mono tracking-tighter">${r.value}</p>
                    </div>
                </div>
                <input type="checkbox" class="recipient-checkbox w-6 h-6 rounded-lg border-gray-700 bg-gray-800 checked:bg-[#dfffad] focus:ring-0" 
                    value="${r.value}" ${selectedRecipients.includes(r.value) ? 'checked' : ''}>
            </label>
        `).join('');

        document.getElementById('pickerOverlay').classList.remove('hidden');
    }

    function closePicker() {
        if (currentTargetCam) {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);

            if (currentTargetCam === 'patrol') {
                patrolConfig.recipients = selected;
                const label = document.getElementById('patrol-recipients-label');
                label.innerText = getRecipientNames(selected);
            } else {
                allCameras[currentTargetCam].recipients = selected;
                const label = document.getElementById(`label-${currentTargetCam}`);
                label.innerText = getRecipientNames(selected);
            }
        }
        document.getElementById('pickerOverlay').classList.add('hidden');
        currentTargetCam = null;
    }

    async function saveAllConfigs() {
        Object.keys(allCameras).forEach(id => {
            allCameras[id].analysis_prompt = document.getElementById(`prompt-${id}`).value;
            allCameras[id].message_instruction = document.getElementById(`msg-${id}`).value;
            allCameras[id].whatsapp_trigger_phrase = document.getElementById(`trigger-${id}`).value;
            allCameras[id].webhook_enabled = document.getElementById(`webEnable-${id}`).checked;
            allCameras[id].schedule_enabled = document.getElementById(`schedEnable-${id}`).checked;
            allCameras[id].schedule_interval_hrs = document.getElementById(`schedHrs-${id}`).value;
        });

        patrolConfig.prompt = document.getElementById('patrol-prompt').value;
        patrolConfig.message_instruction = document.getElementById('patrol-msg').value;
        patrolConfig.whatsapp_trigger_phrase = document.getElementById('patrol-trigger').value;
        patrolConfig.schedule_enabled = document.getElementById('patrol-schedEnable').checked;
        patrolConfig.schedule_interval_hrs = document.getElementById('patrol-schedHrs').value;

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cameras: allCameras,
                    patrol: patrolConfig
                })
            });
            if (res.ok) showToast("All AI Patrol configurations saved!");
            else showToast("Failed to save configuration.");
        } catch (e) { showToast("Error connecting to server."); }
    }

    async function triggerSingle(id) {
        showToast(`Running diagnostic analysis for ${id}...`);
        try {
            const res = await fetch(`/api/trigger/${encodeURIComponent(id)}`, { method: 'POST' });
            const data = await res.json();
            if (res.ok && data.status === 'success') {
                showToast("Analysis complete. Check logs.");
            } else {
                showToast("Analysis failed: " + (data.message || data.error || "Server error"));
            }
        } catch (e) {
            console.error("Trigger Error:", e);
            showToast("Error triggering analysis. Check console.");
        }
    }

    async function runHomePatrol() {
        showToast("HOME PATROL: Gathering snapshots from all cameras...");
        try {
            const res = await fetch('/api/patrol/summarize', { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                showToast("Home Patrol Success! Check your WhatsApp.");
            } else {
                showToast("Home Patrol failed: " + (data.message || "Unknown error"));
            }
        } catch (e) { showToast("Error starting Home Patrol."); }
    }
    loadData();
</script>
{% endblock %}