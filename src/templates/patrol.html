{% extends "base.html" %}

{% block title %}AI Patrol - Velo Vision{% endblock %}

{% block extra_style %}
.card { background-color: #262626; border: 1px solid #333; }
.btn-primary { background-color: #dfffad; color: #1a1a1a; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
.pulse-glow { animation: pulse-glow 2s infinite; }
@keyframes pulse-glow {
0% { box-shadow: 0 0 0 0 rgba(223, 255, 173, 0.4); }
70% { box-shadow: 0 0 0 10px rgba(223, 255, 173, 0); }
100% { box-shadow: 0 0 0 0 rgba(223, 255, 173, 0); }
}
.finder-face { transition: all 0.2s; cursor: pointer; }
.finder-face:hover { transform: scale(1.05); }
.finder-face.selected { ring: 2px solid #dfffad; }
.finder-face.selected .face-ring { border-color: #dfffad; box-shadow: 0 0 12px rgba(223,255,173,0.4); }
.finder-face .face-ring { border: 2px solid #444; transition: all 0.2s; }
@keyframes scan-pulse {
0%,100% { opacity: 0.5; }
50% { opacity: 1; }
}
.scanning { animation: scan-pulse 1.5s ease-in-out infinite; }
{% endblock %}

{% block content %}
<div class="p-8">
    <header class="mb-10 flex justify-between items-end">
        <div>
            <h2 class="text-3xl font-semibold">AI Patrol</h2>
            <p class="text-gray-400 text-sm mt-1">Central Intelligence & Multi-Camera Analysis</p>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Sidebar: Home Patrol Config -->
        <div class="space-y-6">
            <div class="card rounded-3xl p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-black uppercase tracking-widest text-gray-500">Home Patrol Config</h3>
                    <span id="active-cams-count"
                        class="text-[10px] font-bold bg-[#dfffad] text-[#1a1a1a] px-2 py-0.5 rounded-full">0
                        Cameras</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">Global
                            Context</label>
                        <textarea id="patrol-prompt" rows="3"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar"
                            placeholder="Instruction for holistic patrol..."></textarea>
                    </div>

                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">Message
                            Style</label>
                        <textarea id="patrol-msg" rows="2"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar"
                            placeholder="Delivery style for summary..."></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">WhatsApp
                            Trigger</label>
                        <input type="text" id="patrol-trigger"
                            class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none custom-scrollbar"
                            placeholder="e.g. how is home right now">
                    </div>


                    <div class="pt-4 border-t border-white/5 space-y-3">
                        <div class="flex items-center justify-between">
                            <label
                                class="text-[10px] text-gray-500 font-black uppercase tracking-widest leading-none">Recipients</label>
                            <button onclick="openPicker('patrol')"
                                class="text-[10px] font-bold text-[#dfffad] hover:underline">Select</button>
                        </div>
                        <div id="patrol-recipients-label"
                            class="p-3 bg-white/5 rounded-2xl border border-white/5 text-[10px] text-gray-400 min-h-[40px] flex items-center">
                            No recipients assigned
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/5 space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Periodic
                                Schedule</label>
                            <input type="checkbox" id="patrol-schedEnable"
                                class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="patrol-schedHrs" value="6"
                                class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2 text-xs text-white text-center focus:border-[#dfffad] focus:outline-none placeholder-gray-600 font-mono">
                            <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest">Hours</span>
                        </div>
                    </div>

                    <div class="pt-2 grid grid-cols-2 gap-3">
                        <button onclick="saveAllConfigs()"
                            class="bg-[#1a1a1a] border border-[#dfffad] text-[#dfffad] py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-[#dfffad] hover:text-[#1a1a1a] transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i> Save
                        </button>
                        <button onclick="runHomePatrol()"
                            class="pulse-glow bg-[#dfffad] text-[#1a1a1a] py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:brightness-90 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt"></i> Run
                        </button>
                    </div>
                </div>
            </div>

            <!-- Person Finder -->
            <div class="card rounded-3xl p-6 space-y-5">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-black uppercase tracking-widest text-gray-500">
                        <i class="fa-solid fa-crosshairs mr-1.5 text-[#dfffad]"></i> Person Finder
                    </h3>
                    <span id="finder-selected-count"
                        class="text-[10px] font-bold bg-white/10 text-gray-400 px-2 py-0.5 rounded-full">0
                        selected</span>
                </div>

                <!-- Face Selection Grid -->
                <div>
                    <label
                        class="block text-[10px] text-gray-500 mb-3 font-black uppercase tracking-widest leading-none">Select
                        People to Find</label>
                    <div id="finder-faces-grid" class="grid grid-cols-4 gap-2.5">
                        <div class="col-span-4 text-center py-6 text-gray-600 text-xs italic">Loading faces...</div>
                    </div>
                    <button onclick="toggleAllFinderFaces()"
                        class="mt-2 text-[9px] font-bold text-gray-500 hover:text-[#dfffad] transition-colors uppercase tracking-widest">
                        <i class="fa-solid fa-check-double mr-1"></i> Toggle All
                    </button>
                </div>

                <!-- Custom Prompt -->
                <div>
                    <label
                        class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest leading-none">Custom
                        Instructions</label>
                    <textarea id="finder-prompt" rows="2"
                        class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar"
                        placeholder="e.g. Describe what they are wearing and their mood..."></textarea>
                </div>

                <!-- Run Button -->
                <button id="finder-run-btn" onclick="runPersonFinder()"
                    class="w-full bg-[#1a1a1a] border border-[#dfffad]/50 text-[#dfffad] py-3.5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-[#dfffad] hover:text-[#1a1a1a] transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-crosshairs"></i> Scan All Cameras
                </button>

                <!-- Results Area -->
                <div id="finder-results" class="hidden space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Results</label>
                        <span id="finder-cameras-scanned" class="text-[9px] text-gray-600 font-mono"></span>
                    </div>
                    <div id="finder-results-content" class="space-y-2"></div>
                    <div id="finder-summary"
                        class="mt-3 p-4 bg-white/5 rounded-2xl border border-white/5 text-xs text-gray-300 leading-relaxed max-h-48 overflow-y-auto custom-scrollbar">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main: Per-Camera Config -->
        <div class="xl:col-span-2 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-xl font-semibold">Camera Intelligence</h3>
            </div>

            <div id="camera-intelligence-list" class="space-y-6">
                <div class="text-center py-20 text-gray-600 italic">Scanning for cameras...</div>
            </div>
        </div>
    </div>
</div>

<!-- Recipients Picker Modal -->
<div id="pickerOverlay"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
    <div class="bg-[#262626] border border-gray-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden"
        onclick="event.stopPropagation()">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-[#1e1e1e]/50">
            <h3 class="text-xl font-semibold">Select Recipients</h3>
            <button onclick="closePicker()" class="text-gray-400 hover:text-white"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div id="picker-list" class="p-4 space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
            <!-- Items injected here -->
        </div>
        <div class="p-6 border-t border-gray-700 flex justify-end gap-3">
            <button onclick="closePicker()"
                class="bg-[#dfffad] text-[#1a1a1a] px-8 py-2 rounded-xl font-bold hover:brightness-90 transition-all">Done</button>
        </div>
    </div>
</div>

<div id="toast"
    class="fixed bottom-8 right-8 bg-[#dfffad] text-black px-6 py-3 rounded-2xl font-bold shadow-2xl transform translate-y-28 opacity-0 transition-all duration-300 z-[300]">
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let allCameras = {};
    let allRecipients = [];
    let currentTargetCam = null;
    let patrolConfig = { prompt: '', recipients: [] };
    let allFaces = [];
    let finderSelectedNames = new Set();

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('translate-y-28', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-28', 'opacity-0'), 3000);
    }

    function getRecipientNames(values) {
        if (!values || values.length === 0) return "No recipients assigned";
        return values.map(v => {
            const found = allRecipients.find(r => r.value === v);
            return found ? (found.label || found.name) : v;
        }).join(', ');
    }

    async function loadData() {
        try {
            const [cRes, sRes] = await Promise.all([fetch('/api/cameras'), fetch('/api/settings')]);
            const config = await sRes.json();
            allCameras = config.cameras || {};
            allRecipients = JSON.parse(config.whatsapp.recipients || "[]");
            patrolConfig = config.patrol || { prompt: '', recipients: [] };

            updatePatrolUI();
            renderIntelligenceList();
        } catch (e) { console.error(e); }
    }

    function updatePatrolUI() {
        const count = document.getElementById('active-cams-count');
        const activeCount = Object.values(allCameras).filter(c => c.enabled !== false).length;
        count.innerText = `${activeCount} Camera${activeCount !== 1 ? 's' : ''}`;

        document.getElementById('patrol-prompt').value = patrolConfig.prompt || '';
        document.getElementById('patrol-msg').value = patrolConfig.message_instruction || '';
        document.getElementById('patrol-trigger').value = patrolConfig.whatsapp_trigger_phrase || '';
        document.getElementById('patrol-schedEnable').checked = !!patrolConfig.schedule_enabled;
        document.getElementById('patrol-schedHrs').value = patrolConfig.schedule_interval_hrs || 6;

        const label = document.getElementById('patrol-recipients-label');
        label.innerText = getRecipientNames(patrolConfig.recipients);
    }

    function renderIntelligenceList() {
        const list = document.getElementById('camera-intelligence-list');
        list.innerHTML = '';

        Object.entries(allCameras).forEach(([id, cam]) => {
            const card = document.createElement('div');
            card.className = "card rounded-3xl overflow-hidden p-6 flex flex-col xl:flex-row gap-8 items-start";

            const camRecipients = cam.recipients || [];
            const recipientLabel = getRecipientNames(camRecipients);

            card.innerHTML = `
                <!-- Left Column: Media & Identity -->
                <div class="w-full xl:w-72 shrink-0 space-y-4">
                    <div class="aspect-video bg-black rounded-2xl overflow-hidden relative group border border-white/5 cursor-pointer" onclick="enlargeCamera('${id}', '${cam.name}')">
                        <img src="/api/snapshot?camera_id=${id}&t=${Date.now()}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 opacity-90 group-hover:opacity-100" onerror="handleImageError(this)">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all"></div>
                        <div class="absolute top-2 right-2 flex gap-1.5">
                            <div class="bg-black/60 px-2 py-1 rounded text-[8px] font-black uppercase tracking-widest text-[#dfffad] border border-[#dfffad]/20 backdrop-blur-md">
                                <i class="fa-solid fa-bolt mr-1"></i> Diagnostic
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 px-1">
                        <h4 class="font-bold text-white text-lg leading-tight truncate">${cam.name}</h4>
                        <p class="text-[9px] text-gray-500 font-mono tracking-widest uppercase">${id}</p>
                    </div>

                    <div class="pt-4 border-t border-white/5 px-1">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-[9px] text-gray-500 font-black uppercase tracking-widest">Alert Recipients</label>
                            <button onclick="openPicker('${id}')" class="text-[9px] font-bold text-[#dfffad] hover:underline">Edit</button>
                        </div>
                        <div class="bg-white/5 border border-white/5 rounded-xl p-3 text-[9px] text-gray-400 min-h-[36px] flex items-center">
                            <span id="label-${id}">${recipientLabel}</span>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Context & Automation -->
                <div class="flex-1 w-full space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest">AI Context</label>
                            <textarea id="prompt-${id}" rows="3" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar" placeholder="What should the AI look for?">${cam.analysis_prompt || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-2 font-black uppercase tracking-widest">Notification Style</label>
                            <textarea id="msg-${id}" rows="3" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-2xl px-4 py-3 text-xs text-white focus:border-[#dfffad] focus:outline-none resize-none custom-scrollbar" placeholder="How should the alert be phrased?">${cam.message_instruction || ''}</textarea>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-6 border-t border-white/5">
                        <!-- Triggers -->
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Webhook Trigger</label>
                                    <input type="checkbox" id="webEnable-${id}" ${cam.webhook_enabled ? 'checked' : ''} class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                                </div>
                                <div class="bg-[#1a1a1a] border border-gray-700 rounded-xl px-3 py-2 flex items-center">
                                    <input type="text" readonly value="/api/trigger/${id}" class="bg-transparent text-[9px] text-gray-500 w-full focus:outline-none font-mono">
                                    <i onclick="navigator.clipboard.writeText('/api/trigger/${id}'); showToast('Copied!')" class="fa-regular fa-copy text-gray-400 hover:text-white cursor-pointer ml-2"></i>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-[10px] text-gray-500 font-black uppercase tracking-widest">WhatsApp Trigger Phrase</label>
                                <input type="text" id="trigger-${id}" value="${cam.whatsapp_trigger_phrase || ''}" class="w-full bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2.5 text-xs text-white focus:border-[#dfffad] focus:outline-none" placeholder="e.g. status driveway">
                            </div>
                        </div>

                        <!-- Schedule & Actions -->
                        <div class="space-y-4 flex flex-col justify-between">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <label class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Periodic Auto-Check</label>
                                    <input type="checkbox" id="schedEnable-${id}" ${cam.schedule_enabled ? 'checked' : ''} class="w-4 h-4 rounded border-gray-700 bg-gray-800 checked:bg-[#dfffad]">
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="schedHrs-${id}" value="${cam.schedule_interval_hrs || 1}" class="w-20 bg-[#1a1a1a] border border-gray-700 rounded-xl px-4 py-2 text-xs text-white text-center focus:border-[#dfffad] focus:outline-none font-mono">
                                    <span class="text-[10px] text-gray-500 uppercase font-black tracking-widest text-right">Hour Interval</span>
                                </div>
                            </div>

                            <div class="pt-4 flex gap-3">
                                <button onclick="triggerSingle('${id}')" class="flex-1 bg-white/5 border border-white/10 text-white py-2.5 rounded-xl font-black uppercase text-[10px] tracking-widest hover:bg-white/10 transition-all">
                                    Test
                                </button>
                                <button onclick="saveAllConfigs()" class="flex-[2] bg-[#dfffad] text-[#1a1a1a] py-2.5 rounded-xl font-black uppercase text-[10px] tracking-widest hover:brightness-110 transition-all shadow-lg shadow-[#dfffad]/10">
                                    Save Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function openPicker(targetId) {
        currentTargetCam = targetId;
        const list = document.getElementById('picker-list');

        let selectedRecipients = [];
        if (targetId === 'patrol') {
            selectedRecipients = patrolConfig.recipients || [];
        } else {
            selectedRecipients = allCameras[targetId].recipients || [];
        }

        list.innerHTML = allRecipients.map(r => `
            <label class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/10 transition-all mb-2 last:mb-0">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-[#dfffad]/10 text-[#dfffad] flex items-center justify-center font-bold text-sm">
                        ${r.type === 'person' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-users"></i>'}
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white">${r.label || r.name}</p>
                        <p class="text-[10px] text-gray-500 font-mono tracking-tighter">${r.value}</p>
                    </div>
                </div>
                <input type="checkbox" class="recipient-checkbox w-6 h-6 rounded-lg border-gray-700 bg-gray-800 checked:bg-[#dfffad] focus:ring-0" 
                    value="${r.value}" ${selectedRecipients.includes(r.value) ? 'checked' : ''}>
            </label>
        `).join('');

        document.getElementById('pickerOverlay').classList.remove('hidden');
    }

    function closePicker() {
        if (currentTargetCam) {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);

            if (currentTargetCam === 'patrol') {
                patrolConfig.recipients = selected;
                const label = document.getElementById('patrol-recipients-label');
                label.innerText = getRecipientNames(selected);
            } else {
                allCameras[currentTargetCam].recipients = selected;
                const label = document.getElementById(`label-${currentTargetCam}`);
                label.innerText = getRecipientNames(selected);
            }
        }
        document.getElementById('pickerOverlay').classList.add('hidden');
        currentTargetCam = null;
    }

    async function saveAllConfigs() {
        Object.keys(allCameras).forEach(id => {
            allCameras[id].analysis_prompt = document.getElementById(`prompt-${id}`).value;
            allCameras[id].message_instruction = document.getElementById(`msg-${id}`).value;
            allCameras[id].whatsapp_trigger_phrase = document.getElementById(`trigger-${id}`).value;
            allCameras[id].webhook_enabled = document.getElementById(`webEnable-${id}`).checked;
            allCameras[id].schedule_enabled = document.getElementById(`schedEnable-${id}`).checked;
            allCameras[id].schedule_interval_hrs = document.getElementById(`schedHrs-${id}`).value;
        });

        patrolConfig.prompt = document.getElementById('patrol-prompt').value;
        patrolConfig.message_instruction = document.getElementById('patrol-msg').value;
        patrolConfig.whatsapp_trigger_phrase = document.getElementById('patrol-trigger').value;
        patrolConfig.schedule_enabled = document.getElementById('patrol-schedEnable').checked;
        patrolConfig.schedule_interval_hrs = document.getElementById('patrol-schedHrs').value;

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cameras: allCameras,
                    patrol: patrolConfig
                })
            });
            if (res.ok) showToast("All AI Patrol configurations saved!");
            else showToast("Failed to save configuration.");
        } catch (e) { showToast("Error connecting to server."); }
    }

    async function triggerSingle(id) {
        showToast(`Running diagnostic analysis for ${id}...`);
        try {
            const res = await fetch(`/api/trigger/${encodeURIComponent(id)}`, { method: 'POST' });
            const data = await res.json();
            if (res.ok && data.status === 'success') {
                showToast("Analysis complete. Check logs.");
            } else {
                showToast("Analysis failed: " + (data.message || data.error || "Server error"));
            }
        } catch (e) {
            console.error("Trigger Error:", e);
            showToast("Error triggering analysis. Check console.");
        }
    }

    async function runHomePatrol() {
        showToast("HOME PATROL: Gathering snapshots from all cameras...");
        try {
            const res = await fetch('/api/patrol/summarize', { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                showToast("Home Patrol Success! Check your WhatsApp.");
            } else {
                showToast("Home Patrol failed: " + (data.message || "Unknown error"));
            }
        } catch (e) { showToast("Error starting Home Patrol."); }
    }
    // ─── Person Finder ────────────────────────────────────────────────
    async function loadFinderFaces() {
        try {
            const res = await fetch('/api/faces');
            allFaces = await res.json();
            renderFinderGrid();
        } catch (e) { console.error('Failed to load faces', e); }
    }

    function renderFinderGrid() {
        const grid = document.getElementById('finder-faces-grid');
        if (!allFaces.length) {
            grid.innerHTML = `<div class="col-span-4 text-center py-6 text-gray-600 text-xs italic">No known faces registered. Add faces in the Faces page first.</div>`;
            return;
        }
        grid.innerHTML = allFaces.map(f => {
            const selected = finderSelectedNames.has(f.name);
            return `
                <div class="finder-face flex flex-col items-center gap-1.5 p-2 rounded-2xl ${selected ? 'selected bg-[#dfffad]/10' : 'bg-white/5 hover:bg-white/10'}" onclick="toggleFinderFace('${f.name}')">
                    <div class="face-ring w-12 h-12 rounded-full overflow-hidden ${selected ? '' : ''}">
                        <img src="/api/faces/${encodeURIComponent(f.name)}/image" class="w-full h-full object-cover" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 40%22><rect fill=%22%23333%22 width=%2240%22 height=%2240%22/><text x=%2220%22 y=%2224%22 text-anchor=%22middle%22 fill=%22%23888%22 font-size=%2216%22>${f.name[0]}</text></svg>'">
                    </div>
                    <span class="text-[9px] font-bold ${selected ? 'text-[#dfffad]' : 'text-gray-400'} truncate w-full text-center leading-tight">${f.name}</span>
                </div>
            `;
        }).join('');
        updateFinderCount();
    }

    function toggleFinderFace(name) {
        if (finderSelectedNames.has(name)) {
            finderSelectedNames.delete(name);
        } else {
            finderSelectedNames.add(name);
        }
        renderFinderGrid();
    }

    function toggleAllFinderFaces() {
        if (finderSelectedNames.size === allFaces.length) {
            finderSelectedNames.clear();
        } else {
            allFaces.forEach(f => finderSelectedNames.add(f.name));
        }
        renderFinderGrid();
    }

    function updateFinderCount() {
        const el = document.getElementById('finder-selected-count');
        const count = finderSelectedNames.size;
        el.innerText = `${count} selected`;
        if (count > 0) {
            el.className = 'text-[10px] font-bold bg-[#dfffad] text-[#1a1a1a] px-2 py-0.5 rounded-full';
        } else {
            el.className = 'text-[10px] font-bold bg-white/10 text-gray-400 px-2 py-0.5 rounded-full';
        }
    }

    async function runPersonFinder() {
        if (finderSelectedNames.size === 0) {
            showToast('Select at least one person to find.');
            return;
        }

        const btn = document.getElementById('finder-run-btn');
        const resultsArea = document.getElementById('finder-results');
        const resultsContent = document.getElementById('finder-results-content');
        const summaryEl = document.getElementById('finder-summary');
        const scannedEl = document.getElementById('finder-cameras-scanned');

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-radar scanning"></i> Scanning cameras...';
        btn.classList.add('opacity-60');

        resultsArea.classList.remove('hidden');
        resultsContent.innerHTML = `<div class="text-center py-6 text-gray-500 text-xs scanning"><i class="fa-solid fa-crosshairs mr-2"></i>Searching for ${finderSelectedNames.size} person(s) across all cameras...</div>`;
        summaryEl.innerHTML = '';

        try {
            const res = await fetch('/api/patrol/find', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    names: Array.from(finderSelectedNames),
                    prompt: document.getElementById('finder-prompt').value
                })
            });
            const data = await res.json();

            if (data.status === 'success') {
                scannedEl.innerText = `${data.cameras_scanned} cameras scanned`;
                renderFinderResults(data);
                showToast('Person Finder complete!');
            } else {
                resultsContent.innerHTML = `<div class="text-center py-4 text-red-400 text-xs">${data.message || 'Search failed'}</div>`;
                showToast('Person Finder failed: ' + (data.message || 'Unknown error'));
            }
        } catch (e) {
            resultsContent.innerHTML = `<div class="text-center py-4 text-red-400 text-xs">Connection error</div>`;
            showToast('Error running Person Finder.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i> Scan All Cameras';
            btn.classList.remove('opacity-60');
        }
    }

    function renderFinderResults(data) {
        const resultsContent = document.getElementById('finder-results-content');
        const summaryEl = document.getElementById('finder-summary');
        let html = '';

        // Found persons
        const found = data.found || {};
        for (const [name, locations] of Object.entries(found)) {
            for (const loc of locations) {
                const confColor = loc.confidence === 'high' ? 'text-green-400 bg-green-400/10 border-green-400/20' :
                    loc.confidence === 'medium' ? 'text-yellow-400 bg-yellow-400/10 border-yellow-400/20' :
                        'text-orange-400 bg-orange-400/10 border-orange-400/20';
                html += `
                    <div class="flex items-start gap-3 p-3.5 bg-[#dfffad]/5 border border-[#dfffad]/15 rounded-2xl">
                        <div class="w-9 h-9 rounded-full overflow-hidden shrink-0 border-2 border-[#dfffad]/40">
                            <img src="/api/faces/${encodeURIComponent(name)}/image" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-bold text-[#dfffad]">${name}</span>
                                <span class="text-[8px] font-black uppercase tracking-widest px-1.5 py-0.5 rounded border ${confColor}">${loc.confidence}</span>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-0.5"><i class="fa-solid fa-video mr-1 text-gray-600"></i>${loc.camera_name}</p>
                            <p class="text-[11px] text-gray-300 mt-1 leading-relaxed">${loc.activity}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Not found persons
        const notFound = data.not_found || [];
        for (const name of notFound) {
            html += `
                <div class="flex items-center gap-3 p-3.5 bg-white/5 border border-white/5 rounded-2xl opacity-60">
                    <div class="w-9 h-9 rounded-full overflow-hidden shrink-0 border-2 border-gray-700">
                        <img src="/api/faces/${encodeURIComponent(name)}/image" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <span class="text-xs font-bold text-gray-400">${name}</span>
                        <p class="text-[10px] text-red-400/70 mt-0.5"><i class="fa-solid fa-eye-slash mr-1"></i>Not found in any camera</p>
                    </div>
                </div>
            `;
        }

        if (!html) {
            html = '<div class="text-center py-4 text-gray-500 text-xs">No results to display</div>';
        }

        resultsContent.innerHTML = html;
        summaryEl.innerHTML = (data.summary || '').replace(/\n/g, '<br>');
    }

    loadData();
    loadFinderFaces();
</script>
{% endblock %}